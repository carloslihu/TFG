<!DOCTYPE html>
<html>
<head>
  <title>Simple Map</title>

  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
  <script
    src="https://code.jquery.com/jquery-3.4.0.min.js"
    integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
    crossorigin="anonymous"></script>
</head>

<body>
<nav>
  <h1><a href="{{ url_for('index') }}">Mapa</a></h1>
</nav>

<section class="content">
  <!--<header>
    {% block header %}{% endblock %}
  </header>-->
  {% block content %}{% endblock %}
  <div class="left-panel">
    <div id="map"></div>
    <form name="form1" action="/query" method="post">
      <label for="date_init">Fecha de inicio</label>
      <input name="date_init" id="date_init" type="datetime" onblur="document.form2.date_init.value = this.value;"
             value="{% if date_init is defined %}{{ date_init }}{% else %}2000-01-01 00:00:00{% endif %}">

      <label for="date_end">Fecha de fin</label>
      <input name="date_end" id="date_end" type="datetime" onblur="document.form2.date_end.value = this.value;"
             value="{% if date_end is defined %}{{ date_end }}{% else %}2020-01-01 00:00:00{% endif %}">

      <hr/>
      <hr/>

      <label for="tel">Teléfono Objetivo</label>
      <input name="tel" id="tel" value="{{ tel }}" required>


      <input type="submit" value="Query">
    </form>
    <hr/>
    <form name="form2" action="/query2" method="post">

      <input name="date_init" id="date_init" type="hidden">
      <input name="date_end" id="date_end" type="hidden">


      <label for="lat">latitud</label>
      <input name="lat" id="lat" value="{{ lat }}" required>

      <label for="lon">longitud</label>
      <input name="lon" id="lon" value="{{ lon }}" required>

      <label for="range">radio</label>
      <input name="range" id="range" value="{{ radio }}" required>

      <input type="submit" value="Query2">
    </form>
    <script>
      //Con esta función hacemos que ambos forms compartan los input de fecha
      document.form2.date_init.value = document.form1.date_init.value;
      document.form2.date_end.value = document.form1.date_end.value;
    </script>

    {% for message in get_flashed_messages() %}
      <div class="flash">{{ message }}</div>
    {% endfor %}
  </div>
  <div class="right-panel">
    <!--TODO: Hacer tabla scrollable-->
    <table id="data">
      <tr>
        <th>Teléfono Origen</th>
        <th>Teléfono Destino</th>
        <th>Fecha</th>
      </tr>
    </table>

  </div>
  <script>
    function getCurrentDate() {
      let currentDate = new Date();

      let date = currentDate.getDate();
      let month = currentDate.getMonth(); //Be careful! January is 0 not 1
      let year = currentDate.getFullYear();

      return date + "-" + (month + 1) + "-" + year;
    }

    /*Esta función se encarga de insertar un value en el hashmap<object,value>
    * Internamente compara el object para ver si ya existía otro obj con los mismos parámetros
    * Devuelve true si se ha insertado un objeto nuevo*/
    function MapInsertObject(map, object, value) {
      for (const obj of map.keys()) {
        /*Caso en que ya existía otro objeto con los mismos parámetros*/
        if (JSON.stringify(obj) === JSON.stringify(object)) {
          map.set(obj, map.get(obj) + value);
          return false;
        }
      }
      //si no estaba en el hashmap
      map.set(object, value);
      return true;
    }

    let map;
    const apiKey = 'AIzaSyB1cLa1Z2_iBh9jtBKnAEa9BQa9vo8-2oQ';

    function initMap() {
      //coordenadas por defecto
      let sol = {lat: 0, lng: -180};
      let zoom = 15;
      let flightPlanCoordinates = [];

      let coordinates;
      let circles = [];
      let ranges = [];
      let infowindows = [];
      let lastOpenedInfoWindow;
      let markers = [];
      let text = [];
      let contents = new Map(); //Empty Map
      let content;

      let lineSymbol = {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
      };


      {% if calls is defined and calls|length %} //Caso query por teléfono
        // centramos mapa usando el primer resultado
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: {{ calls[0].Antenna.lat }}, lng: {{ calls[0].Antenna.lon }}},
          zoom: zoom,
        });

        {% for call in calls %}
          coordinates = {lat: {{ call.Antenna.lat }}, lng: {{ call.Antenna.lon }}};
          content = 'tel_o: {{ call.tel_o }} tel_d: {{ call.tel_d }}<br>' +
            'lat: {{ call.Antenna.lat }} lng: {{ call.Antenna.lon }} date_init: {{ call.date_init }}<br><br>';

          if (MapInsertObject(contents, coordinates, content) === true) {
            ranges.push({{ call.Antenna.range }});
          }
          flightPlanCoordinates.push(coordinates);

        {% endfor %}
        let i = 0;
        for (const [key, value] of contents) {

          infowindows.push(new google.maps.InfoWindow({
            content: value
          }));

          markers.push(new google.maps.Marker({
            position: key,
            map: map,
            title: 'Ubicación'
          }));
          // Add the circle for this point to the map.
          circles.push(new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.1,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map,
            center: key,
            radius: ranges[i]
          }));
          i++;
        }
        // Activamos los popups
        for (let i = 0; i < markers.length; i++) {
          markers[i].addListener("click", function () {
            infowindows[i].open(map, markers[i]);
          });
        }

        // Pintamos las trayectorias
        let flightPath = new google.maps.Polyline({
          path: flightPlanCoordinates,
          icons: [{
            icon: lineSymbol,
            offset: '100%'
          }],
          geodesic: true,
          strokeColor: '#FF0000',
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
        flightPath.setMap(map);





      {% elif tels is defined and tels|length  %} //Caso query por latitud longitud
        //centramos en la ubicación filtrada
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: {{ lat }}, lng: {{ lon }}},
          zoom: zoom,
        });

        {% for tel in tels %}
          coordinates = {lat: {{ tel.Antenna.lat }}, lng: {{ tel.Antenna.lon }}};
          /*content = 'tel_o: {{ tel.tel_o }} tel_d: {{ tel.tel_d }}<br>' +
            'lat: {{ tel.Antenna.lat }} lng: {{ tel.Antenna.lon }} date_init: {{ tel.date_init }}<br><br>';*/

          content = '<tr>' +
            '<td>' +
            '<form action="/query" method="post">' +
            '<input name="tel" type="hidden" value="{{ tel.tel_o }}"/>' +
            '<input name="date_init"  type="hidden" value="{{ date_init }}">' +
            '<input name="date_end" type="hidden" value="{{ date_end }}">' +
            '<a href="#" onclick="this.parentNode.submit();">{{ tel.tel_o }}</a>' +
            '</form>' +
            '</td>' +

            '<td>' +
            '<form action="/query" method="post">' +
            '<input name="tel" type="hidden" value="{{ tel.tel_d }}"/>' +
            '<input name="date_init"  type="hidden" value="{{ date_init }}">' +
            '<input name="date_end" type="hidden" value="{{ date_end }}">' +
            '<a href="#" onclick="this.parentNode.submit();">{{ tel.tel_d }}</a>' +
            '</form>' +
            '</td>' +

            '<td>{{ tel.date_init }}</td>' +
            '</tr>';


          if (MapInsertObject(contents, coordinates, content) === true) {
            ranges.push({{ tel.Antenna.range }});
          }

        {% endfor %}
        let i = 0;
        for (const [key, value] of contents) {

          infowindows.push(new google.maps.InfoWindow({
            content: 'latidud: ' + key.lat + ' longitud: ' + key.lng
          }));
          text.push(value);
          markers.push(new google.maps.Marker({
            position: key,
            map: map,
            title: 'Ubicación'
          }));
          // Add the circle for this point to the map.
          circles.push(new google.maps.Circle({
            strokeColor: '#FF0000',
            strokeOpacity: 0.1,
            strokeWeight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.1,
            map: map,
            center: key,
            radius: ranges[i]
          }));
          i++;
        }
        new google.maps.Marker({
          position: {lat: {{ lat }}, lng: {{ lon }}},
          map: map,
          title: 'Ubicación actual'
        });
        circles.push(new google.maps.Circle({
          strokeColor: '#0F0000',
          strokeOpacity: 0.1,
          strokeWeight: 2,
          fillColor: '#0F0000',
          fillOpacity: 0.1,
          map: map,
          center: {lat: {{ lat }}, lng: {{ lon }}},
          radius: {{ radio }}
        }));
        // Activamos los popups
        for (let i = 0; i < markers.length; i++) {
          markers[i].addListener("click", function () {
            //abrir marker cerrando el anterior
            if (lastOpenedInfoWindow) {
              lastOpenedInfoWindow.close();
            }
            infowindows[i].open(map, markers[i]);
            lastOpenedInfoWindow = infowindows[i];

            document.getElementById("data").innerHTML = '<tr>' +
              '<th>Teléfono Origen</th>' +
              '<th>Teléfono Destino</th>' +
              '<th>Fecha</th>' +
              '</tr>' +
              text[i];
            //TODO: cambiar colores de circulos?
          })
        }


      {% else %} /*mapa por defecto si no hay queries*/
        map = new google.maps.Map(document.getElementById('map'), {
          center: sol,
          zoom: 3,
        });
      {% endif %}


      //obtiene el array de puntos más cercanos a los que se consultan (correspondientemente)
      /*$.get('https://roads.googleapis.com/v1/nearestRoads?points=' + '60.170880,24.942795|40.4167278,-3.7033387' + '&key=' + apiKey,
        function (data) {
          for (let i = 0; i < data.snappedPoints.length; i++) {
            let latlng = new google.maps.LatLng(
              data.snappedPoints[i].location.latitude,
              data.snappedPoints[i].location.longitude);
            let marker = new google.maps.Marker({
              position: latlng,
              map: map
            });
          }
        }
      );*/
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1cLa1Z2_iBh9jtBKnAEa9BQa9vo8-2oQ&callback=initMap"
          async defer></script>
</section>
</body>
