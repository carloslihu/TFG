<!DOCTYPE html>
<html>
<head>
  <title>Simple Map</title>

  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
  <script
    src="https://code.jquery.com/jquery-3.4.0.min.js"
    integrity="sha256-BJeo0qm959uMBGb65z40ejJYGSgR7REI4+CW1fNKwOg="
    crossorigin="anonymous"></script>
</head>

<body>
<nav>
  <h1><a href="{{ url_for('index') }}">Mapa</a></h1>
</nav>

<section class="content">
  <header>
    {% block header %}Hola{% endblock %}
  </header>
  {% block content %}{% endblock %}
  <div id="map"></div>
  <form action="/query" method="post">
    <label for="tel_o">tel_o</label>
    <input name="tel_o" id="tel_o" required>

    <label for="tel_d">tel_d</label>
    <input name="tel_d" id="tel_d" required>

    <!--<label for="date_init">date_init</label>
    <input name="date_init" id="date_init" required>

    <label for="date_end">date_init</label>
    <input name="date_end" id="date_end" required>-->



    <input type="submit" value="Query">
  </form>

  <form action="/query2" method="post">
    <label for="lat">tel_o</label>
    <input name="lat" id="lat" required>

    <label for="lon">tel_d</label>
    <input name="lon" id="lon" required>

    <label for="range">tel_d</label>
    <input name="range" id="range" required>

    <input type="submit" value="Query2">
  </form>
  {% for message in get_flashed_messages() %}
    <div class="flash">{{ message }}</div>
  {% endfor %}

  <script>
    let map;
    const apiKey = 'AIzaSyB1cLa1Z2_iBh9jtBKnAEa9BQa9vo8-2oQ';

    function initMap() {
      //coordenadas de sol
      let sol = {lat: 0, lng: -180};
      //centramos el mapa
      {% if calls is defined %}
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: {{ calls[0].Antenna.lat }}, lng: {{ calls[0].Antenna.lon }}},
          zoom: 10,
        });
      {% else %}
        map = new google.maps.Map(document.getElementById('map'), {
          center: sol,
          zoom: 3,
        });
      {% endif %}


      //obtiene el array de puntos m√°s cercanos a los que se consultan (correspondientemente)
      /*$.get('https://roads.googleapis.com/v1/nearestRoads?points=' + '60.170880,24.942795|40.4167278,-3.7033387' + '&key=' + apiKey,
        function (data) {
          for (let i = 0; i < data.snappedPoints.length; i++) {
            let latlng = new google.maps.LatLng(
              data.snappedPoints[i].location.latitude,
              data.snappedPoints[i].location.longitude);
            let marker = new google.maps.Marker({
              position: latlng,
              map: map
            });
          }
        }
      );*/


      //pintamos trayectoria
      let flightPlanCoordinates = [];

      let coordinates, circle;
      let infowindow;
      let marker;
      let infowindows = [];
      let markers = [];
      // Define a symbol using a predefined path (an arrow)
      // supplied by the Google Maps JavaScript API.
      let lineSymbol = {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
      };
      {% for call in calls %}
        coordinates = {lat: {{ call.Antenna.lat }}, lng: {{ call.Antenna.lon }}};
        flightPlanCoordinates.push(coordinates);

        // Creamos los popups
        infowindows.push(new google.maps.InfoWindow({
          content: 'lat: {{ call.Antenna.lat }} lng: {{ call.Antenna.lon }} date_init: {{ call.date_init }}'
        }));
        markers.push(new google.maps.Marker({
          position: coordinates,
          map: map,
          title: 'Uluru (Ayers Rock)'
        }));
        // Add the circle for this city to the map.
        circle = new google.maps.Circle({
          strokeColor: '#FF0000',
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: '#FF0000',
          fillOpacity: 0.35,
          map: map,
          center: coordinates,
          radius: {{ call.Antenna.range }}
        });
      {% endfor %}
      // Activamos los popups
      for (let i = 0; i < markers.length; i++) {
        markers[i].addListener("click", function () {
          infowindows[i].open(map, markers[i]);
        })
      }

      // Pintamos las trayectorias
      let flightPath = new google.maps.Polyline({
        path: flightPlanCoordinates,
        icons: [{
          icon: lineSymbol,
          offset: '100%'
        }],
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 2
      });
      flightPath.setMap(map);

    }
  </script>


  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1cLa1Z2_iBh9jtBKnAEa9BQa9vo8-2oQ&callback=initMap"
          async defer></script>


</section>
</body>
